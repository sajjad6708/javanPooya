<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="assets/css/bootstrap/bootstrap.min.css">
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    #back{
      float: left;
    }
    .card-body{
		background-color: #f7c142bd;
	}
    </style>
  <title>ورود محصول به انبار</title>
</head>

<body>
  <div class="container"><br><br><br>
    <div class="card bg-info  rounded">
      <div class="card-body">
        <br>
        <div class="col-md-6 mx-auto">
          <form id="form">
            <div class="form-row">
              بارکد: <div class="form-group col-md-9">

                <input type="text" class="form-control" id="barcode">
              </div>
            </div>
            <br> <br>
            <div class="form-row">
              تعداد کل : <div class="form-group col-md-3">
                <input type="text" class="form-control" id="total" readonly>
              </div>
              تعداد تکراری : <div class="form-group col-md-3">
                <input type="text" class="form-control" id="repeatCount" readonly>
              </div>
            </div>
            <button type="submit" class="btn "></button>
          </form>
          <div class="form-row">
            حذف: <div class="form-group col-md-9">
              <input type="text" class="form-control" id="remove">
            </div>
          </div>
        </div>

        <div class="card text-center">
          <div class="card-header">
            بارکد خوان
          </div>
          <div class="card-body">
            <table class="table" id="table">
              <tbody>
              </tbody>
            </table>

          </div>
          <div class="card-footer text-muted">
            <a href="" id="convert"> <button type="button" class="btn btn-warning">تبدیل به فایل </button></a>
            <a href="../../../home/home.php"><button type="button" id="back" class="btn btn-info"> بازگشت </button></a>

          </div>
        </div>
      </div>
    </div>

  </div>


  <script src="assets/js/jquery-3.5.1.min.js"></script>
  <script src="assets/js/popper.js"></script>
  <script src="assets/js/bootstrap/bootstrap.min.js"></script>

  <script>


    $(document).ready(function () {

      barcodes = [];
      var repeatCount = 0;
      var repeatCounts = [];
      var totalCount = 0;
     
      function validateGrade(input) {
        var regex = /^[0-9]+$/;
        if (!regex.test(input)) {

          return false;
        }
        return true;
      }

      $("#repeatCount").val(repeatCount);
      $("#total").val(totalCount);
      $("#form").submit(function (event) {

        event.preventDefault();
        var inputBarcode = $("#barcode").val();


        if (validateGrade(inputBarcode)) {

          var total = parseInt($("#total").val()) + 1;
          $("#total").val(total);
         
          var index = barcodes.indexOf(inputBarcode);
         
          if (index === -1) {
           

            barcodes.push(inputBarcode);
            $("#table tbody").prepend("<tr><td>" + inputBarcode + "</td></tr>");
           
             var audio = new Audio("audio/barcodesound.mp3");

            audio.play();

            setTimeout(function () {
              audio.pause();
            }, 1500);
          }
          else {

            var audio2 = new Audio("audio/repeatSound.mp3");

            audio2.play();

            setTimeout(function () {
              audio2.pause();
            }, 1500);

            var count = parseInt($("#repeatCount").val()) + 1;
            $("#repeatCount").val(count);

            $("#table tbody tr").each(function () {
              var rowBarcode = $(this).find("td:first").text();

              if (rowBarcode === inputBarcode) {
                $(this).css("background-color", "red");
              }
            });

            barcodes.push(inputBarcode);
          }
          $("#barcode").val("");
        }
        else {
          var AudioEn = new Audio("audio/notNumber.mp3");
          AudioEn.play();
          $("#barcode").val("");
        }

     

    
      });

      // ==========================================عملیات حذف بارکد=========

      var removeBtn = document.getElementById("remove");
      var table = document.getElementById("table");
      var tr = table.getElementsByTagName("tr");
      var totalCount = 0;
      $("#total").val(totalCount);
      

      removeBtn.addEventListener('keydown', function (event) {
        if (event.key === "Enter") {
          event.preventDefault;


          var input = removeBtn.value.trim();
          if (input === "") {
            var audio = new Audio("audio/errorSound.wav");
            audio.play();
            return;
          }

          var removed = false;
          for (i = 0; i < tr.length; i++) {
            var txtTr = tr[i];

            trValue = txtTr.textContent || txtTr.innerHTML;
           trArr = trValue.split('\n') ; 
           indexx = trArr.indexOf(input);
            if (indexx !==-1) {

              tr[i].parentNode.removeChild(tr[i]);


              trValue = "";
              removed = true;
              var audio = new Audio("audio/removeSound.wav");
              audio.play();


              const removedCount = removeDuplicates(barcodes, input);
              repVal = document.getElementById('repeatCount').value ;
              rep = parseInt(repVal) - parseInt(removedCount) ; 
        

            }
          }

          if (!removed) {
            var audio = new Audio("audio/errorSound.wav");
            audio.play();

          }
          removeBtn.value = "";

        
        
       
          barlenght = barcodes.length;
          $("#total").val(barlenght);
          $("#repeatCount").val(rep);
          

        }

      });
     
    });

    // ===========================اضافه به فایل متنی============================

    $("#convert").click(function () {
     
      var desktopPath = "C:\\Users\\[safir]\\Desktop\\barcode\\";
      var fileName = "sabtBarcodes.txt";
      var fullPath = desktopPath + fileName;
      var uniqueNumbers = [];

      $("table tr td").each(function () {
        var number = $(this).text();
        if ($.inArray(number, uniqueNumbers) === -1) {
          uniqueNumbers.push(number);
        }
      });
      var toStringBarcode = uniqueNumbers.join("\n");

      var file = new Blob([toStringBarcode], { type: "text/plain;charset=utf-8" });
    
      saveAs(file, fileName, desktopPath);
      

    });


    function saveAs(blob, fileName, desktopPath) {

      var url = URL.createObjectURL(blob);
      var a = document.createElement("a");
      document.body.appendChild(a);
      a.style = "display: none";
      a.href = url;
      a.download = fileName; a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
    

    }

// ==============================functions==================================


    function removeDuplicates(array, num) {
      let count = 0;
      
      for (let i = array.length - 1; i >= 0; i--) {
        if (array[i] === num) {
          array.splice(i, 1);
          count++;
        }
      }
      
      return count-1;
    }


  </script>





</body>

</html>